<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>シューティングゲーム</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body {
  margin: 0;
  background: #000;
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100vh;
  overflow: hidden;
}
canvas {
  background: #111;
  display: block;
  touch-action: none; /* スマホでスクロール防止 */
}
#countdown {
  position: absolute;
  top: 50%; left: 50%;
  transform: translate(-50%, -50%);
  color: white;
  font-size: 80px;
  font-family: Arial, sans-serif;
}
button {
  font-size: 20px;
  padding: 15px 30px;
  border: none;
  border-radius: 10px;
  cursor: pointer;
  background: #66ccff;
  color: #fff;
  position: absolute;
  top: 50%; left: 50%;
  transform: translate(-50%, -50%);
  display: none;
}
</style>
</head>
<body>
<canvas id="gameCanvas" width="400" height="600"></canvas>
<div id="countdown"></div>
<button id="retryBtn">リトライ</button>

<script>
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");
const countdownEl = document.getElementById("countdown");
const retryBtn = document.getElementById("retryBtn");

let player, bullets=[], enemies=[], enemyBullets=[];
let gameStarted=false, gameOver=false, startTime=0;

// ===== プレイヤー =====
class Player {
  constructor(){
    this.x=canvas.width/2-15;
    this.y=canvas.height-50;
    this.width=30;
    this.height=30;
    this.speed=5;
  }
  draw(){
    ctx.fillStyle="blue";
    ctx.fillRect(this.x,this.y,this.width,this.height);
  }
  move(dir){
    if(dir==="left" && this.x>0) this.x-=this.speed;
    if(dir==="right" && this.x+this.width<canvas.width) this.x+=this.speed;
  }
}

// ===== 弾 =====
class Bullet {
  constructor(x,y){
    this.x=x; this.y=y; this.width=5; this.height=10; this.speed=7;
  }
  update(){ this.y-=this.speed; }
  draw(){ ctx.fillStyle="red"; ctx.fillRect(this.x,this.y,this.width,this.height); }
}

// ===== 敵 =====
class Enemy {
  constructor(){
    this.x=Math.random()*(canvas.width-30);
    this.y=-30;
    this.width=30; this.height=30;
    this.speed=2;
  }
  update(){
    this.y+=this.speed;
    if(Math.random()<0.02){
      enemyBullets.push(new EnemyBullet(this.x+this.width/2,this.y+this.height));
    }
  }
  draw(){
    ctx.fillStyle="lime";
    ctx.fillRect(this.x,this.y,this.width,this.height);
  }
}

// ===== 敵弾 =====
class EnemyBullet {
  constructor(x,y){
    this.x=x; this.y=y;
    this.width=8; this.height=8;
    this.speed=4;
  }
  update(){ this.y+=this.speed; }
  draw(){ ctx.fillStyle="yellow"; ctx.fillRect(this.x,this.y,this.width,this.height); }
}

// ===== カウントダウン =====
function startCountdown(){
  let t=3;
  countdownEl.innerText=t;
  let timer=setInterval(()=>{
    t--;
    if(t>0){
      countdownEl.innerText=t;
    }else if(t===0){
      countdownEl.innerText="START!";
    }else{
      clearInterval(timer);
      countdownEl.style.display="none";
      startGame();
    }
  },1000);
}

// ===== ゲーム開始 =====
function startGame(){
  player=new Player();
  gameStarted=true;
  startTime=Date.now();
  requestAnimationFrame(gameLoop);
  // 敵生成ループ
  setInterval(()=>{ if(!gameOver) enemies.push(new Enemy()); },1000);
}

// ===== ゲームループ =====
function gameLoop(){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  if(gameStarted && !gameOver){
    // プレイヤー
    player.draw();

    // プレイヤー弾
    for(let i=bullets.length-1;i>=0;i--){
      let b=bullets[i];
      b.update(); b.draw();
      if(b.y<0) bullets.splice(i,1);
    }

    // 敵
    for(let i=enemies.length-1;i>=0;i--){
      let e=enemies[i];
      e.update(); e.draw();
      if(e.y>canvas.height) enemies.splice(i,1);

      // プレイヤーに当たり判定
      if(player.x<e.x+e.width && player.x+player.width>e.x && player.y<e.y+e.height && player.y+player.height>e.y){
        endGame();
      }

      // 弾が敵に当たった
      for(let j=bullets.length-1;j>=0;j--){
        let b=bullets[j];
        if(b.x<e.x+e.width && b.x+b.width>e.x && b.y<e.y+e.height && b.y+b.height>e.y){
          bullets.splice(j,1);
          enemies.splice(i,1);
          break;
        }
      }
    }

    // 敵弾
    for(let i=enemyBullets.length-1;i>=0;i--){
      let eb=enemyBullets[i];
      eb.update(); eb.draw();
      if(eb.y>canvas.height) enemyBullets.splice(i,1);

      // プレイヤーに当たり判定
      if(player.x<eb.x+eb.width && player.x+player.width>eb.x && player.y<eb.y+eb.height && player.y+player.height>eb.y){
        endGame();
      }
    }
  }

  if(gameOver){
    ctx.fillStyle="white";
    ctx.font="30px Arial";
    ctx.textAlign="center";
    ctx.fillText("Game Over",canvas.width/2,50);
  }

  if(!gameOver) requestAnimationFrame(gameLoop);
}

// ===== ゲームオーバー =====
function endGame(){
  gameOver=true;
  retryBtn.style.display="block";
}

// ===== リトライ =====
retryBtn.onclick=()=>location.reload();

// ===== スマホ操作 =====
canvas.addEventListener("touchstart",e=>{
  if(!gameStarted||gameOver) return;
  const touchX = e.touches[0].clientX - canvas.getBoundingClientRect().left;
  if(touchX < canvas.width/2){
    player.move("left");
  }else{
    player.move("right");
  }
});

// ===== 自動射撃 =====
setInterval(()=>{
  if(gameStarted && !gameOver){
    bullets.push(new Bullet(player.x+player.width/2,player.y));
  }
},300);

// ===== ページロードでカウントダウン開始 =====
window.onload=startCountdown;
</script>
</
